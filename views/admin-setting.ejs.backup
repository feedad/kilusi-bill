<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/responsive-admin.css">
    <link href="/css/dark-theme.css" rel="stylesheet">
    <style>
        /* Dark Theme */
        body { 
            background: #1a1d29 !important;
            color: #e0e0e0;
        }
        
        .main-content {
            background: #1a1d29;
        }
        
        /* Mobile responsive fixes */
        @media (max-width: 767.98px) {
            .main-content {
                margin-top: 70px !important;
                padding-top: 10px !important;
                z-index: 1;
            }
        }
        
        /* Card Dark Theme */
        .card {
            background: #252a3d !important;
            border: 1px solid #3a4052;
            color: #e0e0e0;
        }
        
        .card-header {
            background: #2d3348 !important;
            border-bottom: 1px solid #3a4052;
            color: #e0e0e0;
        }
        
        .card-body {
            color: #e0e0e0;
        }
        
        /* Text Colors */
        h2, h3, h4, h5, h6 {
            color: #ffffff !important;
        }
        
        p, span, label, .text-muted {
            color: #b8b8b8 !important;
        }
        
        strong {
            color: #e0e0e0;
        }
        
        /* Form controls dark theme */
        .form-control, .form-select, textarea {
            background-color: #1a1d29;
            border-color: #3a4052;
            color: #e0e0e0;
        }
        
        .form-control:focus, .form-select:focus, textarea:focus {
            background-color: #1a1d29;
            border-color: #4a5fc1;
            color: #e0e0e0;
        }
        
        .form-check-input {
            background-color: #1a1d29;
            border-color: #3a4052;
        }
        
        .form-check-input:checked {
            background-color: #4a5fc1;
            border-color: #4a5fc1;
        }
        
        /* Nav Tabs Dark Theme */
        .nav-tabs {
            border-bottom: 1px solid #3a4052;
        }
        
        .nav-tabs .nav-link {
            color: #b8b8b8;
            border: none;
            border-bottom: 2px solid transparent;
            background: transparent;
        }
        
        .nav-tabs .nav-link:hover {
            color: #e0e0e0;
            border-bottom-color: #4a5fc1;
        }
        
        .nav-tabs .nav-link.active {
            color: #ffffff;
            background: transparent;
            border-bottom-color: #4a5fc1;
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        /* Logo Preview */
        .logo-preview {
            border: 2px dashed #3a4052;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background: #1a1d29;
        }
        
        .logo-preview img {
            max-width: 200px;
            max-height: 100px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <%- include('partials/admin-responsive-sidebar', { page: 'setting', settings: settings }) %>
            
            <main class="col-md-10 main-content ms-sm-auto">
                <div class="container-fluid p-4">
                    <div class="row mb-4">
                        <div class="col-12">
                            <h2><i class="bi bi-gear"></i> Pengaturan Sistem</h2>
                            <p class="text-muted">Konfigurasi pengaturan aplikasi, koneksi, dan integrasi sistem</p>
                        </div>
                    </div>

                    <% if (typeof success !== 'undefined' && success) { %>
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="bi bi-check-circle"></i> <%= success %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    <% } %>
                    <% if (typeof error !== 'undefined' && error) { %>
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="bi bi-exclamation-triangle"></i> <%= error %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    <% } %>

                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                                <i class="bi bi-info-circle"></i> Umum
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="mikrotik-tab" data-bs-toggle="tab" data-bs-target="#mikrotik" type="button" role="tab">
                                <i class="bi bi-router"></i> MikroTik
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="genieacs-tab" data-bs-toggle="tab" data-bs-target="#genieacs" type="button" role="tab">
                                <i class="bi bi-hdd-network"></i> GenieACS
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="billing-tab" data-bs-toggle="tab" data-bs-target="#billing" type="button" role="tab">
                                <i class="bi bi-credit-card"></i> Billing
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="monitoring-tab" data-bs-toggle="tab" data-bs-target="#monitoring" type="button" role="tab">
                                <i class="bi bi-graph-up"></i> Monitoring
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="appearance-tab" data-bs-toggle="tab" data-bs-target="#appearance" type="button" role="tab">
                                <i class="bi bi-palette"></i> Tampilan
                            </button>
                        </li>
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content" id="settingsTabContent">
                        <!-- General Settings Tab -->
                        <div class="tab-pane fade show active" id="general" role="tabpanel">
                            <form action="/admin/setting/general" method="POST">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="bi bi-building"></i> Informasi Perusahaan</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Nama Perusahaan</label>
                                                    <input type="text" class="form-control" name="company_header" value="<%= settings.company_header || '' %>" placeholder="ISP Monitor">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Footer Info</label>
                                                    <input type="text" class="form-control" name="footer_info" value="<%= settings.footer_info || '' %>" placeholder="Powered by Gembok">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="bi bi-server"></i> Server Configuration</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Server Host</label>
                                                    <input type="text" class="form-control" name="server_host" value="<%= settings.server_host || 'localhost' %>" placeholder="localhost">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Server Port</label>
                                                    <input type="number" class="form-control" name="server_port" value="<%= settings.server_port || '3001' %>" placeholder="3001">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="bi bi-save"></i> Simpan Pengaturan Umum
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- MikroTik Settings Tab -->
                        <div class="tab-pane fade" id="mikrotik" role="tabpanel">
                            <form action="/admin/setting/mikrotik" method="POST">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="bi bi-hdd-network"></i> Koneksi MikroTik</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Host / IP Address</label>
                                                    <input type="text" class="form-control" name="mikrotik_host" value="<%= settings.mikrotik_host || '' %>" placeholder="192.168.1.1" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">API Port</label>
                                                    <input type="number" class="form-control" name="mikrotik_port" value="<%= settings.mikrotik_port || '8728' %>" placeholder="8728" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Username</label>
                                                    <input type="text" class="form-control" name="mikrotik_user" value="<%= settings.mikrotik_user || '' %>" placeholder="admin" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Password</label>
                                                    <input type="password" class="form-control" name="mikrotik_password" value="<%= settings.mikrotik_password || '' %>" placeholder="********" required>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="bi bi-ethernet"></i> Interface Configuration</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Main Interface</label>
                                                    <input type="text" class="form-control" name="main_interface" value="<%= settings.main_interface || 'ether1' %>" placeholder="ether1">
                                                    <div class="form-text">Interface utama untuk monitoring bandwidth</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">SNMP Community</label>
                                                    <input type="text" class="form-control" name="snmp_community" value="<%= settings.snmp_community || 'public' %>" placeholder="public">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">SNMP Host</label>
                                                    <input type="text" class="form-control" name="snmp_host" value="<%= settings.snmp_host || '' %>" placeholder="192.168.1.1">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">SNMP Port</label>
                                                    <input type="number" class="form-control" name="snmp_port" value="<%= settings.snmp_port || '161' %>" placeholder="161">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="bi bi-save"></i> Simpan Pengaturan MikroTik
                                                </button>
                                                <a href="/admin/mikrotik-scripts" class="btn btn-info">
                                                    <i class="bi bi-code-slash"></i> Kelola Skrip MikroTik
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- GenieACS Settings Tab -->
                        <div class="tab-pane fade" id="genieacs" role="tabpanel">
                            <form action="/admin/setting/genieacs" method="POST">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="bi bi-hdd-rack"></i> Koneksi GenieACS</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">GenieACS URL</label>
                                                    <input type="text" class="form-control" name="genieacs_url" value="<%= settings.genieacs_url || '' %>" placeholder="http://localhost:7557" required>
                                                    <div class="form-text">URL API GenieACS (biasanya port 7557)</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Username</label>
                                                    <input type="text" class="form-control" name="genieacs_username" value="<%= settings.genieacs_username || '' %>" placeholder="admin">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Password</label>
                                                    <input type="password" class="form-control" name="genieacs_password" value="<%= settings.genieacs_password || '' %>" placeholder="********">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="bi bi-sliders"></i> RX Power Settings</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">RX Power Warning (dBm)</label>
                                                    <input type="number" class="form-control" name="rx_power_warning" value="<%= settings.rx_power_warning || '-27' %>" placeholder="-27" step="0.1">
                                                    <div class="form-text">Threshold warning untuk sinyal lemah</div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">RX Power Critical (dBm)</label>
                                                    <input type="number" class="form-control" name="rx_power_critical" value="<%= settings.rx_power_critical || '-30' %>" placeholder="-30" step="0.1">
                                                    <div class="form-text">Threshold critical untuk sinyal sangat lemah</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="bi bi-save"></i> Simpan Pengaturan GenieACS
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Billing Settings Tab -->
                        <div class="tab-pane fade" id="billing" role="tabpanel">
                            <form action="/admin/setting/billing" method="POST">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="bi bi-credit-card"></i> Payment Gateway</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="alert alert-info">
                                                    <i class="bi bi-info-circle"></i> Untuk konfigurasi Tripay dan payment gateway lainnya, silakan edit langsung file settings.json
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Billing Isolir Profile</label>
                                                    <input type="text" class="form-control" name="billing_isolir_profile" value="<%= settings.billing_isolir_profile || 'isolir' %>" placeholder="isolir">
                                                    <div class="form-text">Profile PPPoE untuk user yang diisolir</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="bi bi-shield-check"></i> Customer Portal</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="customerPortalOtp" id="customerPortalOtp" value="true" <%= settings.customerPortalOtp === 'true' || settings.customerPortalOtp === true ? 'checked' : '' %>>
                                                        <label class="form-check-label" for="customerPortalOtp">
                                                            Aktifkan OTP untuk Customer Portal
                                                        </label>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Panjang OTP</label>
                                                    <input type="number" class="form-control" name="otp_length" value="<%= settings.otp_length || '6' %>" placeholder="6" min="4" max="8">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="bi bi-save"></i> Simpan Pengaturan Billing
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Monitoring Settings Tab -->
                        <div class="tab-pane fade" id="monitoring" role="tabpanel">
                            <form action="/admin/setting/monitoring" method="POST">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="bi bi-activity"></i> PPPoE Monitoring</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="pppoe_monitor_enable" id="pppoe_monitor_enable" value="true" <%= settings.pppoe_monitor_enable === 'true' || settings.pppoe_monitor_enable === true ? 'checked' : '' %>>
                                                        <label class="form-check-label" for="pppoe_monitor_enable">
                                                            Aktifkan PPPoE Monitoring
                                                        </label>
                                                    </div>
                                                    <div class="form-text">Monitor koneksi PPPoE secara real-time</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="bi bi-link-45deg"></i> Quick Links</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="d-grid gap-2">
                                                    <a href="/admin/whatsapp-settings" class="btn btn-success btn-sm">
                                                        <i class="bi bi-whatsapp"></i> Konfigurasi WhatsApp
                                                    </a>
                                                    <a href="/admin/tools" class="btn btn-warning btn-sm">
                                                        <i class="bi bi-tools"></i> Network Tools
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-body">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="bi bi-save"></i> Simpan Pengaturan Monitoring
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Appearance Settings Tab -->
                        <div class="tab-pane fade" id="appearance" role="tabpanel">
                            <form action="/admin/setting/upload-logo" method="POST" enctype="multipart/form-data">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="bi bi-image"></i> Logo Aplikasi</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="mb-3">
                                                    <label class="form-label">Upload Logo</label>
                                                    <input type="file" class="form-control" name="logo" accept="image/*">
                                                    <div class="form-text">Format: PNG, JPG, SVG (Max 2MB)</div>
                                                </div>
                                                <div class="logo-preview">
                                                    <p class="text-muted mb-2">Logo Saat Ini:</p>
                                                    <% if (settings.logo_filename) { %>
                                                        <img src="/img/<%= settings.logo_filename %>?v=<%= Date.now() %>" alt="Current Logo">
                                                    <% } else { %>
                                                        <img src="/img/logo.png?v=<%= Date.now() %>" alt="Default Logo">
                                                    <% } %>
                                                </div>
                                                <button type="submit" class="btn btn-primary mt-3">
                                                    <i class="bi bi-upload"></i> Upload Logo Baru
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-6">
                                        <div class="card mb-4">
                                            <div class="card-header">
                                                <h5 class="mb-0"><i class="bi bi-palette"></i> Theme Settings</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="alert alert-info">
                                                    <i class="bi bi-info-circle"></i> Aplikasi menggunakan dark theme secara default. Kustomisasi theme dapat dilakukan melalui file CSS.
                                                </div>
                                                <p class="text-muted">Current Theme: <strong>Dark Mode</strong></p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
        // Auto-dismiss alerts after 5 seconds
        setTimeout(function() {
            $('.alert').fadeOut('slow');
        }, 5000);

        // Remember active tab
        const activeTab = localStorage.getItem('activeSettingsTab');
        if (activeTab) {
            const tabTrigger = new bootstrap.Tab(document.querySelector(`#${activeTab}-tab`));
            tabTrigger.show();
        }

        // Save active tab to localStorage
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (event) {
                const tabId = event.target.id.replace('-tab', '');
                localStorage.setItem('activeSettingsTab', tabId);
            });
        });
    </script>
</body>
</html>
